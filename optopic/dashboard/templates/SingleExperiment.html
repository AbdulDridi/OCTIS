<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Website Title -->
    <title>OpTopic - {{experimentName}}</title>

    <!-- Styles -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:500,700&display=swap&subset=latin-ext"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,600&display=swap&subset=latin-ext"
        rel="stylesheet">
    <link href="{{ url_for('static', filename='styles/bootstrap.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='styles/fontawesome-all.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='styles/magnific-popup.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='styles/styles.css') }}" rel="stylesheet">

    <!-- Favicon  -->
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.png') }}">

    <style>
        html,
        body,
        #container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body data-spy="scroll" data-target=".fixed-top">

    <!-- Preloader -->
    <div class="spinner-wrapper">
        <div class="spinner">
            <div class="bounce1"></div>
            <div class="bounce2"></div>
            <div class="bounce3"></div>
        </div>
    </div>
    <!-- end of preloader -->


    <!-- Navbar -->
    <nav class="navbar navbar-expand-md navbar-dark navbar-custom fixed-top">

        <!-- Image Logo -->
        <a class="navbar-brand logo-image" href="index.html"><img
                src="{{ url_for('static', filename='images/logo.png') }}" alt="alternative"></a>

        <!-- Mobile Menu Toggle Button -->
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault"
            aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-awesome fas fa-bars"></span>
            <span class="navbar-toggler-awesome fas fa-times"></span>
        </button>
        <!-- end of mobile menu toggle button -->

        <div class="collapse navbar-collapse" id="navbarsExampleDefault">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link page-scroll" href="{{ url_for('home') }}">HOME</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link page-scroll" href="{{ url_for('CreateExperiments') }}">CREATE EXPERIMENTS</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link page-scroll" href="{{ url_for('VisualizeExperiments') }}">VISUALIZE
                        EXPERIMENTS</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link page-scroll" href="{{ url_for('ManageExperiments') }}">MANAGE EXPERIMENTS</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link page-scroll" href="{{ url_for('shutdown') }}">CLOSE DASHBOARD</a>
                </li>
            </ul>
        </div>
    </nav> <!-- end of navbar -->
    <!-- end of navbar -->


    <!-- Header -->
    <header id="header" class="ex-header">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h1>{{experimentName}}</h1>
                </div> <!-- end of col -->
            </div> <!-- end of row -->
        </div> <!-- end of container -->
    </header> <!-- end of ex-header -->
    <!-- end of header -->


    <div id="projects" class="accordion">
        <div style="float: left; width: 50%; height: 100%;">
            <div style="height: 10%;" id="expSelector"></div>
            <div style="height: 35%;" id="optInfo"></div>
            <div style="height: 10%;" id="iterationSelector"></div>
            <div style="height: 40%;" id="expInfo"></div>
            <div style="height: 5%"></div>
        </div> <!-- end of col -->
        <div style="float: left; width: 50%; height: 100%;">
            <div style="height: 85%;" id="container"></div>
            <div style="height: 15%;" id="topicSelector"></div>
        </div>

    </div> <!-- end of col -->


    <div class="accordion">
        <div style="float: left; width: 31%; height: 100%;">
            <div style="height: 10%;">
                <input type="number" value="0" id="docSelector" min="0" max="{{ datasetMetadata['total_documents'] }}">
                <input type="button" value="Ok" onclick="updateDocViewer()">
            </div>
            <div id="docTopic" style="height: 60%;"></div>
            <div id="docPreview" style="height: 30%;"></div>
        </div>
        <div style="float: left; width: 31%; height: 100%;">
            <div style="height: 10%;">
                <select id="wordSelector" class="form-control-select" onchange="updateWordGraph()"></select>
            </div>
            <div id="wordTopic" style="height: 90%;"></div>
        </div>
        <div id="generic" style="float: left; width: 31%; height: 100%;"></div>
    </div>


    <!-- Footer -->
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <div class="text-container about">
                        <h4>Optopic</h4>
                        <p class="white">Optimizing topic models made simple.</p>
                    </div> <!-- end of text-container -->
                </div> <!-- end of col -->
            </div> <!-- end of row -->
        </div> <!-- end of container -->
    </div> <!-- end of footer -->
    <!-- end of footer -->


    <!-- Copyright -->
    <div class="copyright">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <p class="p-small">Made in 2020, MIND. Department of Informatics Systems and Communication of Milano
                        Bicocca</p>
                </div> <!-- end of col -->
            </div> <!-- enf of row -->
        </div> <!-- end of container -->
    </div> <!-- end of copyright -->
    <!-- end of copyright -->


    <!-- Scripts -->
    <script type="text/javascript" src="{{ url_for('static', filename='jquery.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='popper.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='bootstrap.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='jquery.easing.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='jquery.magnific-popup.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='scripts.js') }}"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-base.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-tag-cloud.min.js"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='plotly-latest.min.js') }}"></script>


</body>
<script>
    function getParams(vars) {
        return vars;
    }


    function updateDropdownIndex(dropdownId, value) {
        dropDown = document.getElementById(dropdownId)
        for (var i, j = 0; i = dropDown.options[j]; j++) {
            if (i.text == value) {
                dropDown.selectedIndex = j;
                break;
            }
        }
    }

    function isFloat(val) {
        var floatRegex = /^-?\d+(?:[.,]\d*?)?$/;
        if (!floatRegex.test(val))
            return false;

        val = parseFloat(val);
        if (isNaN(val))
            return false;
        return true;
    }


    var output = getParams({{ output| tojson}});
    globalInfo = getParams({{ globalInfo| tojson}});
    iterationInfo = getParams({{ iterationInfo| tojson}});
    var expInfo = getParams({{ expInfo| tojson}});
    expIds = getParams({{ expIds| tojson}});
    expName = getParams({{ experimentName| tojson}});
    var vocabulary = getParams({{ vocabulary| tojson}});


    function writeInfo(elementId, info) {
        ele = document.getElementById(elementId)
        ele.innerHTML = ''
        hyperparams = ''
        if ("hyperparameter_configuration" in info) {
            hyperparams = "<br><b>Hyperparameters configuration:</b>"

            $.each(info["hyperparameter_configuration"], function (key, value) {
                val = value
                if (isFloat(value)) {
                    val = parseFloat(value)
                    val = val.toFixed(4)
                }
                hyperparams = hyperparams + "<br><b>" + key + ":</b> " + val
            });
        }

        node = document.createElement("p")
        node.innerHTML = "<b>Best seen:</b> " + info["best_seen"].toFixed(4) +
            "<br><b>Mean:</b> " + info["mean_seen"].toFixed(4) +
            "<br><b>Median:</b> " + info["median_seen"].toFixed(4) +
            "<br><b>Worst seen:</b> " + info["worse_seen"].toFixed(4) +
            hyperparams;

        ele.appendChild(node)
    }




    selectExp = document.createElement("select")
    selectExp.classList.add("form-control-select")
    selectExp.id = "selecExp"
    selectExp.addEventListener("click", function () {
        infoSelector = JSON.parse(this.value)
        location.href = "../../SingleExperiment/" + infoSelector["batchId"] + "/" + infoSelector["expId"]
    })

    for (const val of expIds) {
        var option = document.createElement("option");
        option.text = val[0];
        option.value = JSON.stringify({ "expId": val[1][1], "batchId": val[1][0] })
        selectExp.appendChild(option)
    }

    document.getElementById("expSelector").appendChild(selectExp)
    updateDropdownIndex(selectExp.id, expName)


    sel = document.getElementById("iterationSelector")

    iterSelect = document.createElement("input")
    iterSelect.classList.add("form-control-number");
    iterSelect.id = "iterselect"
    iterSelect.setAttribute("type", "number");
    iterSelect.setAttribute("min", 0);
    if (globalInfo != false) {
        iterSelect.setAttribute("max", globalInfo["f_val"].length - 1);
    }
    else {
        iterSelect.setAttribute("max", 0);
    }
    iterSelect.defaultValue = 0

    sel.appendChild(document.createTextNode("Iteration: "))
    sel.appendChild(iterSelect)


    runSelect = document.createElement("input")
    runSelect.classList.add("form-control-number");
    runSelect.id = "runselect"
    runSelect.setAttribute("type", "number");
    runSelect.setAttribute("min", 0);
    if (expInfo != false) {
        runSelect.setAttribute("max", expInfo["optimization"]["model_runs"] - 1);
    } else {
        runSelect.setAttribute("max", 0);
    }
    runSelect.defaultValue = 0

    sel.appendChild(document.createTextNode("Model run: "))
    sel.appendChild(runSelect)






    function updateTopicSelector() {
        topicSelector = document.getElementById("topicSelector")
        topicSelector.innerHTML = ''

        topicSelect = document.createElement("select")
        topicSelect.classList.add("form-control-select")
        topicSelect.id = "selecTopic"
        topicSelect.addEventListener("click", function () {
            draw(this.value)
        })

        if (output != false) {

            for (i = 0; i < output["topic-word-matrix"].length; i++) {
                var option = document.createElement("option");
                option.text = i;
                option.value = i;
                topicSelect.appendChild(option)
            }
        }

        topicSelector.appendChild(topicSelect)
    }

    updateTopicSelector()


    but = document.createElement("BUTTON")
    but.innerHTML = "ok"
    but.addEventListener("click", function () {
        $.ajax(
            {
                type: 'POST',
                url: "/getIterationData",
                contentType: 'application/json;charset=UTF-8',
                dataType: 'json',
                data: JSON.stringify({
                    "data": {
                        "batchId": expInfo["batchId"],
                        "experimentId": expInfo["experimentId"],
                        "iteration": document.getElementById("iterselect").value,
                        "model_run": document.getElementById("runselect").value,
                    }
                }),
                success: function (data) {
                    console.log(data["iterInfo"])
                    if (data["iterinfo"] != false && data["expinfo"] != false) {
                        writeInfo("expInfo", data["iterInfo"])
                        output = data["output"]
                        updateTopicSelector()
                        draw(0)
                    }
                }
            })

    })


    function updateDocViewer() {
        $.ajax(
            {
                type: 'POST',
                url: "/getDocPreview",
                contentType: 'application/json;charset=UTF-8',
                dataType: 'json',
                data: JSON.stringify({
                    "data": {
                        "dataset": expInfo["dataset"],
                        "document": document.getElementById("docSelector").value
                    }
                }),
                success: function (data) {
                    preview = document.getElementById("docPreview")
                    if (data["doc"] == false) data["doc"] = "document not found"
                    preview.innerHTML = "<b>Doument preview</b><br>" + data["doc"]

                    datax = []
                    datay = []

                    if (output != false) {

                        for (var i = 0; i < output["topic-document-matrix"].length; i++) {
                            datax.push(i)
                            datay.push(output["topic-document-matrix"][i][document.getElementById("docSelector").value])
                        }
                    }

                    var bardata = [
                        {
                            x: datax,
                            y: datay,
                            type: 'bar'
                        }
                    ];

                    var layout = {
                        margin: {
                            l: 40,
                            r: 40,
                            b: 40,
                            t: 40,
                            pad: 2
                        },
                        paper_bgcolor: 'rgba(256,256,256,1)'
                    };

                    document.getElementById("docTopic").innerHTML = ""

                    Plotly.newPlot('docTopic', bardata, layout);



                }
            })
    }

    updateDocViewer()

    sel.appendChild(but)



    if (globalInfo != false) writeInfo("optInfo", globalInfo)
    if (iterationInfo != false) writeInfo("expInfo", iterationInfo)







    anychart.onDocumentReady(function () {
        draw(0)
    });



    function draw(topic) {

        document.getElementById("container").innerHTML = ''

        var data = []

        if (output != false) {

            for (i = 0; i < output["topics"][topic].length; i++) {
                data.push({ "x": output["topics"][topic][i][0], "value": output["topics"][topic][i][1], category: topic })
            }
        }


        var chart = anychart.tagCloud(data);
        chart.title('Wordcloud')
        chart.angles([0])
        chart.colorRange(true);
        chart.colorRange().length('80%');
        chart.container("container");
        chart.draw();
    }



    function draw2() {

        if (globalInfo != false) {

            cont = document.getElementById("generic");

            second_axe = [0]

            for (i = 1; i < globalInfo["f_val"].length; i++) {
                second_axe.push(i);
            }

            var layout = {
                margin: {
                    l: 50,
                    r: 50,
                    b: 40,
                    t: 40,
                    pad: 4
                },
                paper_bgcolor: 'rgba(256,256,256,1)'
            };


            var trace = {
                x: second_axe,
                y: globalInfo["f_val"],
                type: 'scatter'
            }

            Plotly.newPlot("generic", [trace], layout);

        }
    }

    draw2()

    wordselector = document.getElementById("wordSelector")

    if (vocabulary != false) {

        Object.keys(vocabulary).forEach(function (key) {
            option = document.createElement("option")
            option.text = vocabulary[key];
            option.value = key;
            wordselector.appendChild(option)

        });
    }



    function updateWordGraph() {
        if (vocabulary != false && output != false) {
            wordselector = document.getElementById("wordSelector")
            word = vocabulary[wordselector.text]




            datax = []
            datay = []

            for (var i = 0; i < output["topic-word-matrix"].length; i++) {
                datax.push(i)
                datay.push(output["topic-word-matrix"][i][wordselector.value])
            }

            var bardata = [
                {
                    x: datax,
                    y: datay,
                    type: 'bar'
                }
            ];

            var layout = {
                margin: {
                    l: 40,
                    r: 40,
                    b: 40,
                    t: 40,
                    pad: 2
                },
                paper_bgcolor: 'rgba(256,256,256,1)'
            };

            document.getElementById("wordTopic").innerHTML = ""

            Plotly.newPlot('wordTopic', bardata, layout);
        }
    }
    if (vocabulary != false)
        updateDropdownIndex("wordSelector", Object.keys(vocabulary)[0])
    updateWordGraph()




</script>

</html>